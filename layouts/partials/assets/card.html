<!-- 
    Displays a Bootstrap card. Either specify a valid path, or set the arguments title, href, header, description, and
    thumbnail individually. The latter arguments override any page attributes.
    
    The shortcode supports the following arguments:
    "path"          Optional path of the page, override with other parameters.
    "title"         Required title of the card.
    "href"          Required address for the button or hyperlink.
    "class"         Optional class attribute of the card element, e.g. “w-50”.
    "color":        Optional theme color of the card, either "primary", "secondary", "success", "danger",
                    "warning", "info", "light", or "dark". By default, no color is specified.
    "padding":      Optional padding of the content, either "0", "1", "2", "3", "4", "5", or "auto" (default).
    "header"        Optional header of the card, displayed in small caps.
    "description"   Optional description of the card.
    "thumbnail"     Optional thumbnail image url, displayed on top or the left of the card.
    "orientation"   Optional placecement of the thumbnail, either "stacked" (default), "horizontal", or "none".
-->

{{ $page := "" }}
{{ if .path }}
    {{ $page = site.GetPage .path }}
    {{ if not $page }}
        {{ errorf "Cannot find page: %s" .path -}}
    {{ end }}
{{ end }}

{{ $title := "" }}
{{ $href := "" }}
{{ $header := "" }}
{{ $description := "" }}
{{ $thumbnail := "" }}

{{ $color := "" -}}
{{ with .color }}{{ $color = . }}{{ end -}}
{{ if $color }}
    {{ $supportedColors := slice "primary" "secondary" "success" "danger" "warning" "info" "light" "dark" -}}
    {{ if not (in $supportedColors $color) -}}
        {{ errorf "Invalid value for param 'color': %s" $color -}}
    {{ end -}}
{{ end -}}

{{ $layout := "rich" -}}
{{ with .layout }}{{ $layout = . }}{{ end -}}
{{ $supportedLayouts := slice "rich" "minimal" -}}
{{ if not (in $supportedLayouts $layout) -}}
    {{ errorf "Invalid value for param 'layout': %s" $layout -}}
{{ end -}}

{{ with $page }}
    {{ if not $title }}{{ $title = $page.Params.title }}{{ end }}
    {{ if not $href }}{{ $href = $page.Permalink  }}{{ end }}
    {{ if not $description }}{{ $description = $page.Params.description }}{{ end }}
    {{ if not $thumbnail }}{{ $thumbnail = $page.Params.thumbnail }}{{ end }}

    {{ if not $header }}
        {{ if eq $layout "rich" }}
            {{ $header = partial "utilities/date.html" (dict "date" .Date "format" "long") -}}
            {{ $header = printf "%s &bull; %d %s %s" $header .ReadingTime (i18n "minutesShort") (i18n "read") }}
            {{ if isset .Params "tags" -}}
                {{ range first 1 (.GetTerms "tags") -}}
                    {{ $link := "text-decoration-none text-primary" }}
                    {{ if $color }}{{ $link = "card-link" }}{{ end }}
                    {{ $header = printf "%s &bull; <a href=\"%s\" class=\"%s\" aria-label=\"Tag: %s\">%s</a>" $header ((path.Join .Page.RelPermalink) | relURL) $link .LinkTitle .LinkTitle }}
                {{ end -}}
            {{ end -}}
        {{ else }}
            {{ $thumbnail = "" }}
        {{ end }}
    {{ end }}
{{ end }}

{{ if not $title }}
    {{ errorf "Missing value for param 'title'" -}}
{{ end }}

{{ if not $href }}
    {{ errorf "Missing value for param 'href'" -}}
{{ end }}

{{ $class := .class }}

{{ $padding := "auto" }}
{{ with .padding }}{{ $padding = . }}{{ end -}}
{{ $supportedPaddings := slice "0" "1" "2" "3" "4" "5" "auto" -}}
{{ if not (in $supportedPaddings $padding) -}}
    {{ errorf "Invalid value for param 'padding': %s" $padding -}}
{{ end -}}

{{ $orientation := "stacked" -}}
{{ with .orientation }}{{ $orientation = . }}{{ end -}}
{{ $supportedOrientations := slice "stacked" "horizontal" "none" -}}
{{ if not (in $supportedOrientations $orientation) -}}
    {{ errorf "Invalid value for param 'orientation': %s" $orientation -}}
{{ end -}}
{{ if eq $orientation "none" }}{{ $thumbnail = "" }}{{ end }}

{{ define "partials/card-body.html" }}
    {{ $header := .header }}
    {{ $title := .title }}
    {{ $href := .href }}
    {{ $color := .color }}
    {{ $description := .description }}
    
    {{ with $header }}<p class="card-text"><small class="{{ if $color }}text-bg-{{ $color }}{{ else }}text-muted{{ end }} text-uppercase">{{ . | safeHTML }}</small></p>{{ end }}
    <a href="{{ $href }}" class="text-decoration-none card-link">
        <p class="card-title fs-5 fw-bold">{{ $title }}</p>
        {{ with $description }}<p class="card-text mb-4 {{ if $color }}text-bg-{{ $color }}{{ end }}">{{ . }}</p>{{ end }}
    </a>
{{ end }}

{{ if eq $orientation "horizontal" }}
    <div class="card mb-3 {{ with $color }}bg-{{ . }} text-bg-{{ . }}{{ end }} {{ $class }}">
        <div class="row g-0">
            <div class="col-4">
                {{ if $thumbnail -}}
                    <a href="{{ $href }}">
                        {{- partial "image.html" (dict "url" $thumbnail "ratio" "1x1" "outerClass" "h-100 card-img-wrap" "innerClass" "rounded-start card-img-h100" "title" $title) -}}
                    </a>
                {{ end }}
                </div>
            <div class="col-8">
                <div class="card-body h-100 p-{{ $padding }}">
                    {{ partial "card-body.html" (dict "header" $header "title" $title "href" $href "color" $color "description" $description) }}
                </div>
            </div>
        </div>
    </div>
{{ else }}
    <div class="card {{ with $color }}bg-{{ . }} text-bg-{{ . }}{{ end }} {{ $class }}">
        {{ if $thumbnail -}}
            <a href="{{ $href }}">
                {{- partial "image.html" (dict "url" $thumbnail "ratio" "16x9" "outerClass" "card-img-wrap" "innerClass" "card-img-top" "title" $title) -}}
            </a>
        {{ end }}
        <div class="card-body d-flex flex-column p-{{ $padding }}">
            {{ partial "card-body.html" (dict "header" $header "title" $title "href" $href "color" $color "description" $description) }}
        </div>
    </div>
{{ end }}
